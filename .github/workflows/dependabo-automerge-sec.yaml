name: Dependabot auto-merge sec

on:
  push:
    branches:
      - main

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: List Dependabot branches
        run: |
          gh pr list --author dependabot --state open --json number,headRefName -q '.[] | {number: .number, headRefName: .headRefName}' > pr-list.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Process Dependabot PRs
        id: process-prs
        run: |
          pr_list=$(cat pr-list.json)
          for pr in $(echo "${pr_list}" | jq -c '.[]'); do
            number=$(echo "${pr}" | jq -r '.number')
            head_ref=$(echo "${pr}" | jq -r '.headRefName')

            # Checkout the branch
            git checkout ${head_ref}

            # Rebase onto main
            git rebase main

            # Push the updated branch
            git push --force-with-lease origin ${head_ref}

            # Merge the PR
            gh pr merge ${number} --squash --delete-branch --repo $GITHUB_REPOSITORY --admin
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        run: git checkout main
